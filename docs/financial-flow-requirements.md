# Finanz 자금 흐름 시스템 요구사항

## 1. 시스템 개요
Finanz는 여러 금융 채널(은행 계좌, 카드, 페이/포인트, 투자 계정 등)에서 추출한 거래 데이터를 공통 스키마로 집계해 자금 흐름을 추적·시각화·시뮬레이션하는 재무 플랫폼이다. 모든 거래는 `occurredAt`, `transactionType`, `amount`, `institution`, `counterAccount`, `metadata`, `raw`를 갖춘 JSON 레코드로 저장된다. 이 문서는 최소 9가지 핵심 기능을 만족하기 위한 구조 및 기능 요구사항을 정리한다.

## 2. 데이터 구조 요구사항
1. **표준 거래 스키마 유지**  
   - 레코드: `id`, `occurredAt.{iso,utc}`, `transactionType`, `description`, `amount`, `balance`, `institution`, `counterAccount`, `memo`, `metadata`, `raw`.  
   - 파일: `generatedAt`, `sourceFile`, `timezone`, `account`, `period.{from,to}`, `summary`, `records[]`.
2. **금융 채널 엔티티 모델링**  
   - `institution`/`counterAccount`를 바탕으로 계좌·카드·페이/포인트 객체를 생성하고 거래 히스토리를 연결한다.
3. **자금 흐름 그래프 도출**  
   - 거래를 `from → to` 엣지로 변환하는 규칙을 정의하고, 동일 금액·시간대 거래를 매칭해 “자기 계좌 간 이동”을 식별한다.

## 3. 기능 요구사항
| 번호 | 기능 | 설명 |
| --- | --- | --- |
| 1 | 자금 흐름 추적 | 시간순 거래와 관계를 추적하는 API/서비스 구성 |
| 2 | 금융채널 객체화 | 계좌/카드/페이별 객체 생성, 히스토리·잔액 관리 |
| 3 | 중복/자체 이체 감지 | 동일 금액/타임스탬프 거래를 매칭해 순 현금흐름 계산 시 제외 |
| 4 | Canvas 시각화 | react-flow 등으로 채널/거래 그래프를 표현할 데이터 제공 |
| 5 | 인컴 소스 객체화 | 급여·환불·프로모션 등 소득원을 분류해 캐시플로 추적 |
| 6 | 예상 인컴 시뮬레이션 | Forecast 거래를 받아 미래 잔액/현금흐름을 계산 |
| 7 | 투자 자산 추적 | 투자 계정/상품을 모델링하고 수익률을 시뮬레이션 |
| 8 | LLM 기반 재무/세무 조언 | MCP가 표준 스키마 데이터를 활용해 조언 제공 |
| 9 | 조언/정책 히스토리 | LLM 조언과 실제 결과를 기록해 효과를 평가 |

## 4. 서비스/모듈 요구사항
1. **정규화/수집 모듈**: 모든 ingest 스크립트는 표준 스키마를 출력하고, 신규 소스에 대해 normalize 스크립트를 제공한다.
2. **분류 & 태깅 엔진**: 거래에 소득/지출, 계좌 간 이동, 세금 관련 태그를 자동 부여한다.
3. **중복/상호거래 탐지**: 금액·타임스탬프·기관쌍을 비교하는 매칭 알고리즘을 갖추고 결과를 `metadata.matchId` 등에 기록한다.
4. **시각화 API**: `{ nodes: Channel[], edges: Flow[] }` 형태로 그래프 데이터를 제공하며 시간 필터/시나리오 옵션을 지원한다.
5. **시뮬레이션 엔진**: Forecast 레코드를 포함한 시뮬레이션을 실행하고 결과 리포트를 생성한다.
6. **투자 자산 모듈**: `instrumentId`, `shares`, `price` 등 확장 메타데이터로 자산 변동을 추적하고 외부 시세와 연동한다.
7. **LLM/MCP 통합**: `/transactions`, `/channels`, `/flows`, `/simulations` 등 API를 설계해 MCP가 단일 호출로 데이터를 조회한다.

## 5. 비기능 요구사항
- **일관성**: 모든 거래 JSON은 스키마 검증을 통과해야 하며 CI 단계에서 자동 검사한다.
- **보안/프라이버시**: 이메일·계좌번호 등 민감 데이터는 최소화하거나 마스킹한다.
- **성능**: 수천 건 거래를 대상으로도 1–2초 내 흐름 추적·시뮬레이션이 가능하도록 인덱싱/캐시 전략을 마련한다.
- **확장성**: 신규 금융 채널을 쉽게 추가할 수 있도록 ingestion/normalize 패턴을 모듈화한다.
- **감사로그**: Normalize, 태깅, 시뮬레이션 적용 내역을 기록해 회계/세무 감사에 대비한다.

## 6. 향후 단계 제안
1. 카테고리/태그 엔진 설계 및 규칙 정의
2. 중복/자체 이체 탐지 알고리즘 PoC 구현
3. Graph API + React Flow 시각화 프로토타입
4. Forecast 입력 포맷과 시뮬레이션 보고서 설계
5. LLM용 MCP 도구 스펙 정의 (쿼리 파라미터, 출력 포맷, 안전 가이드라인)
6. Markdown ↔ DB 동기 구조 수립: `data/financial.md` 같은 요약 문서는 LLM 친화적 기술 문서로 유지하되, 모든 원천 데이터는 DB를 진실의 단일 소스로 관리하고 리포트는 DB에서 자동 생성한다.
